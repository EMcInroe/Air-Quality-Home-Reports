---
title: "Air Quality Plots"
author: "Melissa McInroe"
date: "2024-06-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load library, message = FALSE, warning=FALSE}
require(tidyr)
require(dplyr)
require(ggplot2)
require(lubridate)
require(plotly)
require(ggpubr)
require(data.table)
require(janitor)
require(viridis)
require(patchwork)
require(htmlwidgets)
require(ggpmisc)
library(openair)
library(ggbraid)
library(zoo)
library(stringr)
```

```{r load data, warning=FALSE}
setwd()
load()
names(all_data)

pa_data<-fread()
names(pa_data)

# Apply FASM corrections - 
pa_data <- pa_data |>
  mutate(pm2_5_cf_1 = 0.5*(pm2.5_cf_1_a + pm2.5_cf_1_b),
         eq_1=pm2_5_cf_1*0.524-0.0862*humidity_a+5.75, # EQ 1
         eq_3=pm2_5_cf_1^2*4.21*10^(-4)+pm2_5_cf_1*0.392+3.44, # EQ 3
         eq_2=(0.0244*pm2_5_cf_1-13.9)*eq_3 + 
           (1-(0.0244*pm2_5_cf_1-13.9))*eq_1, # EQ 2
         pm2_5_pa = case_when(pm2_5_cf_1 < 570 ~ eq_1,
                               pm2_5_cf_1 >= 570 & pm2_5_cf_1 < 611 ~ eq_2,
                               pm2_5_cf_1 >= 611 ~ eq_3)) |>
  mutate(date = time_stamp) |>
  arrange(date)

## treatment groups
treat_schedule<-fread()

## intervention period by household
part_start_end<-fread()
names(part_start_end)
part_start_end$House_id<-str_sub(part_start_end$House_id,1,3)
part_start_end$start_date<-str_pad(part_start_end$start_date,6,"0",side = "left") 

ozone_df<-fread()
colnames(ozone_df)<-c("Date","Ozone_AQI_Value","Main_Pollutant","Site_Name","Site_ID","Source")
```

```{r join datasets}
# work with a slimmed down outdoor dataset
data_out <- all_data |>
  ungroup() |>
  select(date,pm2_5_airnow,pm10_t640,pm2_5_t640,
         pm2_5_bluesky,pm10_bluesky,co2_bluesky,no2_bluesky,o3_bluesky,so2_bluesky) |>
  distinct(.keep_all=TRUE) |>
  mutate(pm2_5_bluesky_cor = 4.31 + 0.8746*pm2_5_bluesky)

# join with purpleair dataset
data_out <- full_join(data_out,pa_data,by=join_by(date))
```

```{r clean up outliers}
# remove spike in AirNow dataset
data_out <- data_out |>
  mutate(pm2_5_airnow = ifelse(pm2_5_airnow>50,NaN,pm2_5_airnow),
         pm2_5_t640 = ifelse(pm2_5_t640>50,NaN,pm2_5_t640),
         pm10_t640 = ifelse(pm10_t640 > 200, NaN, pm10_t640)) 

```

```{r visualize outdoor data}
# visualize the time series
g1<-ggplot(data_out) +
  geom_line(aes(x=date,y=pm2_5_bluesky_cor),color="cyan",size=0.5)  +
  geom_line(aes(x=date,y=pm2_5_airnow),color="grey43",size=0.5) +
  geom_line(aes(x=date,y=pm2_5_t640),color="magenta2",size=0.3) +
  geom_line(aes(x=date,y=pm2_5_pa),color="grey10",size=0.2) 

ggplotly(g1)

g2<-ggplot(data_out) +
  geom_line(aes(x=date,y=pm10_bluesky),color="cyan",size=0.5)  +
  geom_line(aes(x=date,y=pm10_t640),color="magenta2",size=0.3)

ggplotly(g2)

```

```{r linear fits}
# PurpleAir correlation to AirNow
ggplot(data_out,aes(x=pm2_5_airnow,y=pm2_5_pa)) +
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2"))) + 
  geom_abline(intercept = 0, slope = 1) 

# BlueSky correlation to AirNow
ggplot(data_out,aes(x=pm2_5_airnow,y=pm2_5_bluesky_cor)) +
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2"))) + 
  geom_abline(intercept = 0, slope = 1) 

# BlueSky correlation to T640
ggplot(data_out,aes(x=pm2_5_t640,y=pm2_5_bluesky_cor)) +
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2"))) + 
  geom_abline(intercept = 0, slope = 1) 

# BlueSky correlation to T640
ggplot(data_out,aes(x=pm10_t640,y=pm10_bluesky)) +
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2"))) + 
  geom_abline(intercept = 0, slope = 1) 

# BlueSky correlation to PurpleAir
ggplot(data_out,aes(x=pm2_5_bluesky_cor,y=pm2_5_pa)) +
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2"))) + 
  geom_abline(intercept = 0, slope = 1) 

ggplot(data_out) +
  geom_point(aes(x=date,y=pm2_5_pa,color=humidity_a),size=0.5)  +
  geom_line(aes(x=date,y=pm2_5_bluesky_cor),color = "grey38",size=0.2) +
  scale_color_viridis(option="turbo")

```

## Calendar Plots

```{r calendar, warning = FALSE}
intervention_pm25<-subset(data_out, date>="2023-10-07")


breaks <- c(0, 9, 35.4, 55.4, 125.4, 225.4,325)
labels <- c("Good\n(0.0-9.0)", "Moderate\n(9.1-35.4)", "Unhealthy for\nSensitive Groups\n(35.5-55.4)", "Unhealthy\n(55.5-125.4)", "Very Unhealthy\n(125.5-225.4)", "Hazardous\n(225.5+)")

#png(_calendarplot.png")
cal_plot<-calendarPlot(intervention_pm25, 
             year=2023,
             pollutant="pm2_5_bluesky_cor",
             labels=labels,
             breaks=breaks,
             w.shift=1,
             w.abbr.len = 3,
             statistic="mean",
             annotate="date",
             cex.lim = c(4,10),
             cols=c("green","yellow","orange","red","purple","maroon"),
             par.settings=list(fontsize=list(text=25)),font.lab = 2)
pdf("/calendarplot_eng_wnumeric_v2.pdf")
    #width = 1400,
#     height = 1200)

#cal_plot$plot$par.settings$par.strip.text = 10
print(cal_plot)
dev.off()



```

## Calendar Plots: Spanish Version

```{r spanish calendar, warning = FALSE}

labels <- c("Bueno\n(0.0-9.0)","Moderado\n(9.1-35.4)","Insalubre para\ngrupos sensibles\n(35.5-55.4)","Insalubres\n(55.5-125.4)","Muy insalubre\n(125.5-225.4)","Peligroso\n(225.5+)")

Sys.setlocale("LC_TIME","Spanish")

pdf("_spanish_calendarplot.pdf")
cal_plot<-calendarPlot(intervention_pm25, 
             year=2023,
             pollutant="pm2_5_bluesky_cor",
             labels=labels,
             breaks=breaks,
             w.shift=1,
             statistic="mean",
             annotate="date",
             cols=c("green","yellow","orange","red","purple","maroon"),
             par.settings=list(fontsize=list(text=25)))

#cal_plot$plot$par.settings$par.strip.text = 10
dev.off()
Sys.setlocale("LC_TIME","English")
```

## Add treatment variable

```{r trtment}

colnames(treat_schedule)<-c("part_ID", "house_ID_treat")

treat_schedule$treatment<-substr(treat_schedule$house_ID_treat, 5,5)
#treat_schedule$house_ID<-substr(treat_schedule$house_ID_treat,1,3)
treat_schedule$treatment<-ifelse(treat_schedule$house_ID=="", "C",treat_schedule$treatment)
treat_schedule$house_ID_treat<-NULL

ambass_houses<-c()
ambassador_data<-treat_schedule[which(treat_schedule$treatment=="A")]
all_data_ambassador<-subset(all_data, house_id %in% ambass_houses)

treat_schedule<-subset(treat_schedule, treatment=="C" | treatment=="T")
treat_schedule$treatment<-factor(treat_schedule$treatment, labels = c("Control","Treatment"))

all_data<-left_join(all_data, treat_schedule, by=c("participant_id_1"="part_ID"))

missing_trtment<-distinct(all_data[,c(3,53)])
all_data<-subset(all_data, !is.na(treatment))

## Add corrected pm2.5
all_data<-left_join(all_data, data_out[,c(1,11)], by="date")

all_data$pm2_5_indr_cor<- 4.31 + 0.8746*all_data$pm2_5
all_data_ambassador$pm2_5_indr_cor<- 4.31 + 0.8746*all_data_ambassador$pm2_5

```

## Home air quality plots with filter power data

Add open door data to control rooms. Need to check the way the average is calculated.\
Need to create Spanish Version.\
This version does not use corrected indoor values.

```{r home plots, eval = FALSE, echo = FALSE}
room_id_list<-unique(all_data$room_id)
no_power<-c("",unique(all_data$room_id[which(all_data$treatment=="Control")]))
wrong_power<-c()
no_indoor_above<-c()

for(i in seq(room_id_list)) {
  room = room_id_list[i]
if(room %in% no_power) {
  plot_df<-all_data[which(all_data$room_id ==room),c("date","pm2_5","power","main_door")]
plot_df<-left_join(plot_df,data_out[,c("date","pm2_5_bluesky_cor")], by = "date")

if(room %in% no_indoor_above) {
  col <- "#FFFFFF00"
    alpha_val<-0
} else {
  col <-c("grey4","#FFFFFF00")
  alpha_val<-0.3
}

plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
start_date<-""
end_date<-""

plot_df<-subset(plot_df, date>=start_date & date<=end_date)

plot_df$time<-1:nrow(plot_df)

plot_df_average6hr<-plot_df
plot_df_average6hr<-plot_df_average6hr %>%
  mutate(moving_avg_indr = rollmean(pm2_5, k = 6, fill = NA, align = "right"),
         moving_avg_outdr=rollmean(pm2_5_bluesky_cor, k = 6, fill = NA, align = "right"))
plot_df_average6hr$hr6<-ifelse((plot_df_average6hr$time %% 6)==0,"yes","no")
plot_df_average6hr<-subset(plot_df_average6hr, hr6 == "yes")
plot_door<-subset(plot_df, main_door>0)
bar_height<-max(pmax(plot_df_average6hr$moving_avg_indr, plot_df_average6hr$moving_avg_outdr, na.rm = T), na.rm=T) +5
mid_height<-bar_height/2

# png(paste0("/",room,"_indr_outdr_AQ_plot.png"),
#     width=1200, height = 900)
p<-ggplot(plot_df) +
  geom_rug(data = plot_door,mapping = aes(x =datetime_tz, y =main_door), color = "darkolivegreen", sides = "b") +
  # geom_tile(data = plot_door,mapping = aes(x =datetime_tz, y =mid_height), 
  #           fill = "turquoise", alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df_average6hr,mapping = aes(x = datetime_tz, y = moving_avg_indr, color = "Indoor")) +
  geom_braid(data = plot_df_average6hr,aes(x = datetime_tz, ymin = moving_avg_indr, ymax = moving_avg_outdr, fill = moving_avg_indr<moving_avg_outdr), alpha = alpha_val) +
  geom_line(data = plot_df_average6hr, mapping = aes(x = datetime_tz, y = moving_avg_outdr, color = "Outdoor")) +
  #scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "2 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  guides(fill = "none") +
  theme(panel.background = element_blank(),
        #panel.grid.major.y = element_line(color = "gray80"),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "top",
        legend.title = element_text(size = 12, face = "bold"))
print(p)
#dev.off()
} else {
plot_df<-all_data[which(all_data$room_id ==room),c("date","pm2_5","power","main_door")]
plot_df<-left_join(plot_df,data_out[,c("date","pm2_5_bluesky_cor")], by = "date")

plot_df_power<-subset(all_data, power>20 & room_id ==room)

if(room %in% wrong_power) {
  start_date<-""
  end_date<-""
  plot_df_power<-subset(plot_df_power,date>=start_date & date<=end_date)
} else {

start_date<-min(plot_df_power$date)
end_date<-max(plot_df_power$date)
}

plot_df<-subset(plot_df, date>=start_date & date<=end_date)
plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
plot_df_power$datetime_tz<-as.POSIXct(format(plot_df_power$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")

plot_df$time<-1:nrow(plot_df)

plot_df_average6hr<-plot_df
plot_df_average6hr<-plot_df_average6hr %>%
  mutate(moving_avg_indr = rollmean(pm2_5, k = 6, fill = NA, align = "right"),
         moving_avg_outdr=rollmean(pm2_5_bluesky_cor, k = 6, fill = NA, align = "right"))
plot_df_average6hr$hr6<-ifelse((plot_df_average6hr$time %% 6)==0,"yes","no")
plot_df_average6hr<-subset(plot_df_average6hr, hr6 == "yes")
bar_height<-max(pmax(plot_df_average6hr$moving_avg_indr, plot_df_average6hr$moving_avg_outdr, na.rm = T), na.rm=T) +5
mid_height<-bar_height/2

if(room %in% no_indoor_above) {
  col <- "#FFFFFF00"
    alpha_val<-0
} else {
  col <-c("grey4","#FFFFFF00")
  alpha_val<-0.3
}

# png(paste0("/",room,"_indr_outdr_AQ_plot.png"),
#     width=1200, height = 900)
p<-ggplot(plot_df) +
  geom_braid(data = plot_df_average6hr,aes(x = datetime_tz, ymin = moving_avg_indr, ymax = moving_avg_outdr, fill = moving_avg_indr<moving_avg_outdr), alpha = alpha_val) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = "lightgreen", alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df_average6hr,mapping = aes(x = datetime_tz, y = moving_avg_indr, color = "Indoor")) +
  geom_line(data = plot_df_average6hr, mapping = aes(x = datetime_tz, y = moving_avg_outdr, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "2 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +
  guides(fill = "none") +
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "bottom",
        legend.title = element_text(size = 12, face = "bold"))
print(p)
#dev.off()
      }
  }
```

## Home Reports version 2

In this version of the home reports there are two plots created. One plot shows the peaks where indoor air quality is above outdoor air quality. The hourly data is not averaged in order to show the variability, but a plot to show a snippet of time is created to highlight what is happening during the indoor peaks. In the second plot the shading for the peaks is removed and it only shows the filter data and the air quality. Another snippet of time plot is created to highlight the use of the air cleaner. Indoor pm2.5 is corrected using the same correction as the outdoor.

### Indoor AQ Peak Plots

*Change the way the snippet is selected

```{r eval = FALSE}
room_id_list<-unique(all_data$room_id)
house_id_list<-unique(all_data$house_id)
intervention_pm25<-subset(all_data, date>="")

# no_power<-c("",unique(all_data$room_id[which(all_data$treatment=="Control")]))
# wrong_power<-c()
no_indoor_above<-c()
no_indoor_pm<-c()

for(i in seq(room_id_list)) {
  room = room_id_list[i]
  plot_df<-intervention_pm25[which(intervention_pm25$room_id == room),c("house_id","date","pm2_5_bluesky_cor","main_door",
                                                                        "pm2_5_indr_cor","other_door")]
  house<-plot_df$house_id[1]
  if(room %in% no_indoor_pm) {
    enddate<-""
  }else {
  start_date<-min(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])
  enddate<-max(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])
  }
  plot_df<-subset(plot_df, date<=enddate)

  alpha_val<-0.3
   col <-c("grey4","#FFFFFF00")

plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
# start_date<-""
# end_date<-""

plot_df$time<-1:nrow(plot_df)

plot_door<-subset(plot_df, main_door>0 | other_door>0)
## plot_door$open_door<-
# bar_height<-max(pmax(plot_df_average6hr$moving_avg_indr, plot_df_average6hr$moving_avg_outdr, na.rm = T), na.rm=T) +5
# mid_height<-bar_height/2

png(paste0("/",house,"/",room,"_indr_peak_plot.png"),
    width=1200, height = 900)

# png(paste0("/",room,"_indr_peak_plot.png"),
#     width=1200, height = 900)

p<-ggplot(plot_df) +
  geom_rug(data = plot_door,mapping = aes(x =datetime_tz, y =main_door), color = "darkolivegreen", sides = "b") +
  # geom_tile(data = plot_door,mapping = aes(x =datetime_tz, y =mid_height), 
  #           fill = "turquoise", alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df,mapping = aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_braid(data = plot_df,aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val) +
  geom_line(data = plot_df, mapping = aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  #scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "2 days", date_labels = "%b %d", limits = c(start_date,enddate)) +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  guides(fill = "none") +
  theme(panel.background = element_blank(),
        #panel.grid.major.y = element_line(color = "gray80"),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "top",
        legend.title = element_text(size = 12, face = "bold"))
print(p)

dev.off()
#----------------------------------------------------------------------------------------------------------------------------------------------------------------

if(room %in% no_indoor_pm) {
  next
}else {

above_outdr<-plot_df$date[which(plot_df$pm2_5_indr_cor>plot_df$pm2_5_bluesky_cor)][round(length(which(plot_df$pm2_5_indr_cor>plot_df$pm2_5_bluesky_cor))/2,0)]
plot_snippet<-subset(plot_df, format(as.Date(date), "%m_%d")==format(as.Date(above_outdr),"%m_%d"))
start_date<-min(plot_snippet$date)
end_date<-max(plot_snippet$date)

png(paste0("/",house,"/",room,"_indr__snippet_peak_plot.png"),
    width=900, height = 700)

#### Snippet of time where the indoor pm2.5 is larger than the outdoor pm2.5.

p<-ggplot(plot_snippet) +
  geom_line(aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_braid(aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val) +
  geom_line(aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "3 hours", date_labels = "%b %d %H:%M", limits=c(start_date, end_date)) +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  guides(fill = "none") +
  theme(panel.background = element_blank(),
        #panel.grid.major.y = element_line(color = "gray80"),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "top",
        legend.title = element_text(size = 12, face = "bold"))
print(p)

dev.off()
    }
}
#----------------------------------------------------------------------------------------------------------------------------------

## Manually change R and R snippet plots to capture higher peaks. 

room<-"R"
  plot_df<-intervention_pm25[which(intervention_pm25$room_id == room),c("house_id","date","pm2_5_bluesky_cor","main_door",
                                                                        "pm2_5_indr_cor","other_door")]
  house<-plot_df$house_id[1]

  start_date<-min(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])
  enddate<-max(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])

  plot_df<-subset(plot_df, date<=enddate)

  alpha_val<-0.3
   col <-c("grey4","#FFFFFF00")

plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
# start_date<-""
# end_date<-""

plot_df$time<-1:nrow(plot_df)

plot_door<-subset(plot_df, main_door>0 | other_door>0)


plot_snippet<-subset(plot_df, format(datetime_tz, "%m_%d")=="10_11")
start_date<-min(plot_snippet$datetime_tz)
end_date<-max(plot_snippet$datetime_tz)


png(paste0("/",house,"/",room,"_indr__snippet_peak_plot.png"),
    width=900, height = 700)

#### Snippet of time where the indoor pm2.5 is larger than the outdoor pm2.5.

p<-ggplot(plot_snippet) +
  geom_line(aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_braid(aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val) +
  geom_line(aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "3 hours", date_labels = "%b %d %H:%M", limits=c(start_date, end_date)) +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  guides(fill = "none") +
  theme(panel.background = element_blank(),
        #panel.grid.major.y = element_line(color = "gray80"),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "top",
        legend.title = element_text(size = 12, face = "bold"))
print(p)

dev.off()
#------------------------------------------------------------------------------------------------------------------------------------------------------

room<-"R"

  plot_df<-intervention_pm25[which(intervention_pm25$room_id == room),c("house_id","date","pm2_5_bluesky_cor","main_door",
                                                                        "pm2_5_indr_cor","other_door")]
  house<-plot_df$house_id[1]

  start_date<-min(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])
  enddate<-max(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])

  plot_df<-subset(plot_df, date<=enddate)

  alpha_val<-0.3
   col <-c("grey4","#FFFFFF00")

plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
# start_date<-""
# end_date<-""

plot_df$time<-1:nrow(plot_df)

plot_door<-subset(plot_df, main_door>0 | other_door>0)


plot_snippet<-subset(plot_df, format(datetime_tz, "%m_%d")=="10_13")
start_date<-min(plot_snippet$datetime_tz)
end_date<-max(plot_snippet$datetime_tz)


png(paste0("/",house,"/",room,"_indr__snippet_peak_plot.png"),
    width=900, height = 700)

#### Snippet of time where the indoor pm2.5 is larger than the outdoor pm2.5.

p<-ggplot(plot_snippet) +
  geom_line(aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_braid(aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val) +
  geom_line(aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "3 hours", date_labels = "%b %d %H:%M", limits=c(start_date, end_date)) +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  guides(fill = "none") +
  theme(panel.background = element_blank(),
        #panel.grid.major.y = element_line(color = "gray80"),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "top",
        legend.title = element_text(size = 12, face = "bold"))
print(p)

dev.off()
```

### Indoor AQ plots with filter data

*Recalculate bar height for filter snippet plot

```{r eval = FALSE}

no_power<-c("",unique(all_data$room_id[which(all_data$treatment=="Control")]), no_indoor_pm)
#wrong_power<-c("")


for(i in seq(room_id_list)) {
  room = room_id_list[i]
if(room %in% no_power) {
     next
} else {
  plot_df<-intervention_pm25[which(intervention_pm25$room_id == room),c("house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]

  house<-plot_df$house_id[1]
  

if(room %in% wrong_power) {
  
  plot_df_power<-subset(all_data, date>="" & room_id ==room)
  # start_date<-""
  # end_date<-""

} else {
  plot_df_power<-subset(all_data, power>20 & room_id ==room)  

}
  
start_date<-pmax(min(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))]),min(plot_df_power$date))
#end_date<-max(plot_df_power$date)
end_date<-max(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])

plot_df<-subset(plot_df, date>=start_date & date<=end_date)
plot_df_power<-subset(plot_df_power, date>=start_date & date<=end_date)
plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
plot_df_power$datetime_tz<-as.POSIXct(format(plot_df_power$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")

plot_df$time<-1:nrow(plot_df)

bar_height<-max(pmax(plot_df$pm2_5_indr_cor, plot_df$pm2_5_bluesky_cor, na.rm = T), na.rm=T) +5
mid_height<-bar_height/2


png(paste0("/",house,"/",room,"_indr_filter_plot.png"),
    width=1200, height = 900)
p<-ggplot(plot_df) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = "lightgreen", alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df,mapping = aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_line(data = plot_df, mapping = aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "2 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "bottom",
        legend.title = element_text(size = 12, face = "bold"))
print(p)
dev.off()

##### Snippet of time where the air filter is on.

power_snippet<-plot_df_power$date[round(nrow(plot_df_power)/2,0)]
plot_snippet<-subset(plot_df, format(as.Date(date), "%m_%d")==format(as.Date(power_snippet),"%m_%d"))
start_date<-min(plot_snippet$date)
end_date<-max(plot_snippet$date)
bar_height<-max(pmax(plot_snippet$pm2_5_indr_cor, plot_snippet$pm2_5_bluesky_cor, na.rm = T), na.rm=T) +5
mid_height<-bar_height/2

png(paste0("/",house,"/",room,"_indr__snippet_filter_plot.png"),
    width=900, height = 700)


p<-ggplot(plot_snippet) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = "lightgreen", alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df,mapping = aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_line(data = plot_df, mapping = aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0), limits = c(0,bar_height))+
  scale_x_datetime(date_breaks = "3 hours", date_labels = "%b %d %H:%M", limits = c(start_date,end_date)) +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "bottom",
        legend.title = element_text(size = 12, face = "bold"))
print(p)


dev.off()
      }
}

```


## Filter plots Alt Version
- add filter data to control groups, but style it differently
- use 2nd week of intervention period
- shorter time period for snippet plot

```{r, warning = FALSE, eval = FALSE}
no_power<-c("", no_indoor_pm)
part_start_end$House_id<-str_sub(part_start_end$House_id,1,3)
part_start_end$start_date<-str_pad(part_start_end$start_date,6,"0",side = "left")  
wrong_power<-c("")


            
##unique(all_data$room_id[which(all_data$treatment=="Control")])

for(i in seq(room_id_list)) {
  room = room_id_list[i]
if(room %in% no_power) {
     next
} 
  
  plot_df<-all_data[which(all_data$room_id == room),c("house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]

  house<-plot_df$house_id[1]
  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(srt_end$start_date)<-2023
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2023
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  

if(room %in% wrong_power) {
  
  plot_df_power<-subset(all_data, date>="" & room_id ==room)
  # start_date<-""
  # end_date<-""

} else {
  plot_df_power<-subset(all_data, power>20 & room_id ==room)  

}
  
plot_df_power$datetime_tz<-as.POSIXct(format(plot_df_power$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
plot_df_power<-subset(plot_df_power, datetime_tz>=srt_end$start_date & datetime_tz<=srt_end$end_date)

plot_df$time<-1:nrow(plot_df)
secnd_wk<-round(nrow(plot_df)/2,0)
plot_df<-subset(plot_df, time>=secnd_wk)
plot_df_power<-subset(plot_df_power, date>=min(plot_df$date))

bar_height<-max(pmax(plot_df$pm2_5_indr_cor, plot_df$pm2_5_bluesky_cor, na.rm = T), na.rm=T) +5
mid_height<-bar_height/2

if(plot_df$treatment[1] == "Treatment") {
  col <- "lightgreen"
} else {
  col = "skyblue"
}

png(paste0("/",house,"/week2_",room,"_indr_filter_plot.png"),
    width=1200, height = 900)
p<-ggplot(plot_df) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = col, alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df,mapping = aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_line(data = plot_df, mapping = aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "bottom",
        legend.title = element_text(size = 12, face = "bold"))
print(p)
dev.off()

##### Snippet of time where the air filter is on.

 power_snippet<-plot_df_power$date[round(nrow(plot_df_power)/2,0)]
plot_snippet<-subset(plot_df, format(as.Date(date), "%m_%d")==format(as.Date(power_snippet),"%m_%d"))[c(1:12),]
start_date<-min(plot_snippet$datetime_tz)
end_date<-max(plot_snippet$datetime_tz)
bar_height<-max(pmax(plot_snippet$pm2_5_indr_cor, plot_snippet$pm2_5_bluesky_cor, na.rm = T), na.rm=T) +5
mid_height<-bar_height/2

png(paste0("/",house,"/",
           room,"_evening_indr_snippet_filter_plot.png"),
    width=900, height = 700)


p<-ggplot(plot_snippet) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height),
            fill = col, alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df,mapping = aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_line(data = plot_df, mapping = aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0), limits = c(0,bar_height))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%b %d %H:%M", limits = c(start_date,end_date)) +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "bottom",
        legend.title = element_text(size = 12, face = "bold"))
print(p)


dev.off()
     
}

                                                                                        
```

## Alt Indoor Peak Plots  

```{r, eval = FALSE}

no_indoor_above<-c()
no_indoor_pm<-c()

for(i in seq(room_id_list)) {
  room = room_id_list[i]
  plot_df<-all_data[which(all_data$room_id == room),c("house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door")]
   plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")              
  house<-plot_df$house_id[1]
  
  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
 
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
 
  
  if(room %in% no_indoor_pm) {
    enddate<-""
  }else {
  enddate<-max(plot_df$datetime_tz[which(!is.na(plot_df$pm2_5_indr_cor))])
  }
    
  start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(start_date)<-2---
  # srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  # year(srt_end$end_date)<-2---
  
  plot_df<-subset(plot_df, datetime_tz<=enddate & date>=start_date)

  alpha_val<-0.3
   col <-c("grey4","#FFFFFF00")


plot_df$time<-1:nrow(plot_df)
mid_time<-round(nrow(plot_df)/2,0)
plot_df<-subset(plot_df,time>=mid_time)

plot_door<-subset(plot_df, main_door>0 | other_door>0)


png(paste0("/",house,"/",room,"_wk2_indr_peak_plot.png"),
    width=1200, height = 900)


p<-ggplot(plot_df) +
  #geom_rug(data = plot_door,mapping = aes(x =datetime_tz, y =main_door), color = "darkolivegreen", sides = "b") +
  # geom_tile(data = plot_door,mapping = aes(x =datetime_tz, y =mid_height), 
  #           fill = "turquoise", alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df,mapping = aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_braid(data = plot_df,aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val) +
  geom_line(data = plot_df, mapping = aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +                           #limits = c(start_date,enddate)
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  guides(fill = "none") +
  theme(panel.background = element_blank(),
        #panel.grid.major.y = element_line(color = "gray80"),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "top",
        legend.title = element_text(size = 12, face = "bold"))
print(p)

dev.off()
#----------------------------------------------------------------------------------------------------------------------------------------------------------------

if(room %in% no_indoor_pm) {
  next
}else {

above_outdr<-plot_df$date[which(plot_df$pm2_5_indr_cor>plot_df$pm2_5_bluesky_cor)][round(length(which(plot_df$pm2_5_indr_cor>plot_df$pm2_5_bluesky_cor))/2,0)]
plot_snippet<-subset(plot_df, format(as.Date(date), "%m_%d")==format(as.Date(above_outdr),"%m_%d"))
plot_snippet$time<-1:nrow(plot_snippet)
plot_snippet<-subset(plot_snippet, time>12)
start_date<-min(plot_snippet$date)
end_date<-max(plot_snippet$date)

png(paste0("/",house,"/",
           room,"_evening_indr_snippet_peak_plot.png"),
    width=900, height = 700)

#### Snippet of time where the indoor pm2.5 is larger than the outdoor pm2.5.

p<-ggplot(plot_snippet) +
  geom_line(aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
  geom_braid(aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val) +
  geom_line(aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%b %d %H:%M", limits=c(start_date, end_date)) +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  guides(fill = "none") +
  theme(panel.background = element_blank(),
        #panel.grid.major.y = element_line(color = "gray80"),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold"),
        legend.position = "top",
        legend.title = element_text(size = 12, face = "bold"))
print(p)

dev.off()
    }
}

#----------------------------------------------------------------------------------------------------------------------------------

# ## Manually change R06 and R12 snippet plots to capture higher peaks. 
# 
# room<-""
#   plot_df<-intervention_pm25[which(intervention_pm25$room_id == room),c("house_id","date","pm2_5_bluesky_cor","main_door",
#                                                                         "pm2_5_indr_cor","other_door")]
#   house<-plot_df$house_id[1]
# 
#   start_date<-min(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])
#   enddate<-max(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])
# 
#   plot_df<-subset(plot_df, date<=enddate)
# 
#   alpha_val<-0.3
#    col <-c("grey4","#FFFFFF00")
# 
# plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
# # start_date<-""
# # end_date<-""
# 
# 
# plot_df$time<-1:nrow(plot_df)
# 
# plot_snippet<-subset(plot_df, format(datetime_tz, "%m_%d")=="10_11")
# start_date<-min(plot_snippet$datetime_tz)
# end_date<-max(plot_snippet$datetime_tz)
# 
# 
# png(paste0("/",house,"/",room,"_indr__snippet_peak_plot.png"),
#     width=900, height = 700)
# 
# #### Snippet of time where the indoor pm2.5 is larger than the outdoor pm2.5.
# 
# p<-ggplot(plot_snippet) +
#   geom_line(aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
#   geom_braid(aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val) +
#   geom_line(aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
#   scale_y_continuous(expand = c(0,0))+
#   scale_x_datetime(date_breaks = "2 hours", date_labels = "%b %d %H:%M", limits=c(start_date, end_date)) +
#   scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
#   scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
#   labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
#   guides(fill = "none") +
#   theme(panel.background = element_blank(),
#         #panel.grid.major.y = element_line(color = "gray80"),
#         axis.line = element_line(color = "black"),
#         axis.title.x = element_blank(),
#         axis.text = element_text(size = 14, face = "bold"),
#         axis.title.y = element_text(size = 14, face = "bold"),
#         legend.position = "top",
#         legend.title = element_text(size = 12, face = "bold"))
# print(p)
# 
# dev.off()
# #------------------------------------------------------------------------------------------------------------------------------------------------------
# 
# room<-"R12"
# 
#   plot_df<-intervention_pm25[which(intervention_pm25$room_id == room),c("house_id","date","pm2_5_bluesky_cor","main_door",
#                                                                         "pm2_5_indr_cor","other_door")]
#   house<-plot_df$house_id[1]
# 
#   start_date<-min(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])
#   enddate<-max(plot_df$date[which(!is.na(plot_df$pm2_5_indr_cor))])
# 
#   plot_df<-subset(plot_df, date<=enddate)
# 
#   alpha_val<-0.3
#    col <-c("grey4","#FFFFFF00")
# 
# plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
# # start_date<-""
# # end_date<-""
# 
# plot_df$time<-1:nrow(plot_df)
# 
# plot_door<-subset(plot_df, main_door>0 | other_door>0)
# 
# 
# plot_snippet<-subset(plot_df, format(datetime_tz, "%m_%d")=="10_13")
# start_date<-min(plot_snippet$datetime_tz)
# end_date<-max(plot_snippet$datetime_tz)
# 
# 
# png(paste0("/",house,"/",room,"_indr__snippet_peak_plot.png"),
#     width=900, height = 700)
# 
# #### Snippet of time where the indoor pm2.5 is larger than the outdoor pm2.5.
# 
# p<-ggplot(plot_snippet) +
#   geom_line(aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor")) +
#   geom_braid(aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val) +
#   geom_line(aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor")) +
#   scale_y_continuous(expand = c(0,0))+
#   scale_x_datetime(date_breaks = "3 hours", date_labels = "%b %d %H:%M", limits=c(start_date, end_date)) +
#   scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
#   scale_fill_manual(values = col, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +                                    #cd4f39
#   labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
#   guides(fill = "none") +
#   theme(panel.background = element_blank(),
#         #panel.grid.major.y = element_line(color = "gray80"),
#         axis.line = element_line(color = "black"),
#         axis.title.x = element_blank(),
#         axis.text = element_text(size = 14, face = "bold"),
#         axis.title.y = element_text(size = 14, face = "bold"),
#         legend.position = "top",
#         legend.title = element_text(size = 12, face = "bold"))
# print(p)
# 
# dev.off()
```


## Version 3 Combined Filter and Peaks with Control  
Need to make it work in a loop

```{r, eval = FALSE}
room_id_list<-unique(all_data$room_id)
house_id_list<-unique(all_data$house_id)


no_indoor_pm<-c()
no_power<-c()

wrong_power<-c()
#no_indoor_above<-c()

part_start_end$House_id<-str_sub(part_start_end$House_id,1,3)
part_start_end$start_date<-str_pad(part_start_end$start_date,6,"0",side = "left")  

intervention_pm25<-subset(all_data, date>="")



for(i in seq(room_id_list)) {
  room = room_id_list[i]
  
  ##Subset Data to intervention period for selected room
  plot_df<-all_data[which(all_data$room_id == room),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]

  house<-plot_df$house_id[1]
  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  ## subset power data for filter on shading
  if(room %in% wrong_power) {
  
  plot_df_power<-subset(all_data, date>="" & room_id ==room)
  # start_date<-""
  # end_date<-""

  } else {
    plot_df_power<-subset(all_data, power>20 & room_id ==room)  

  }
  
  ## select shading based on treatment
  if(plot_df$treatment[1] == "Treatment") {
    col_trt <- "lightgreen"
  } else {
    col_trt = "skyblue"
  }
  
    if(room %in% no_indoor_pm) {
    enddate<-""
  }else {
  enddate<-max(plot_df$datetime_tz[which(!is.na(plot_df$pm2_5_indr_cor))])
  }
    
  start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(start_date)<-2---
  ## Adjust for timezone
  plot_df_power$datetime_tz<-as.POSIXct(format(plot_df_power$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  plot_df_power<-subset(plot_df_power, datetime_tz>=srt_end$start_date & datetime_tz<=srt_end$end_date)
  
  ## only plot second week of intervention
  plot_df$time<-1:nrow(plot_df)
  secnd_wk<-round(nrow(plot_df)/2,0)
  plot_df<-subset(plot_df, time>=secnd_wk)
  plot_df_power<-subset(plot_df_power, date>=min(plot_df$date))
  
  ## adjust bar heights for shading
  bar_height<-max(pmax(plot_df$pm2_5_indr_cor, plot_df$pm2_5_bluesky_cor, na.rm = T), na.rm=T) +5
  mid_height<-bar_height/2
  
  ## select colors for highlighting when indoor is higher than outdoor
  # if(room %in% no_indoor_above) {
  #   col_indr <- "#FFFFFF00"
  #     alpha_val<-0
  # } else {
    col_indr <-c("grey4","#FFFFFF00")
    alpha_val<-0.3
#  }

png(paste0("/",house,"/week2_",room,"_full_plot.png"),
    width=1400, height = 900)  
  
  ## full plot to save for wk 2
  p<-ggplot(plot_df) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = col_trt, alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df,mapping = aes(x = datetime_tz, y = pm2_5_indr_cor, color = "Indoor"), linewidth = 1.2) +
  geom_braid(data = plot_df,aes(x = datetime_tz, ymin = pm2_5_indr_cor, ymax = pm2_5_bluesky_cor, fill = pm2_5_indr_cor<pm2_5_bluesky_cor), alpha = alpha_val,
             method = "line") +
  geom_line(data = plot_df, mapping = aes(x = datetime_tz, y = pm2_5_bluesky_cor, color = "Outdoor"),linewidth = 1.2) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("navyblue", "hotpink2")) +
  scale_fill_manual(values = col_indr, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +  
  labs(y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 18, face = "bold"),
        axis.title.y = element_text(size = 18, face = "bold"),
        legend.position = "none")
  print(p)
 
dev.off() 
  
}


## Average Home PM2.5 bar plot with overall averages
Only the evening temperatures during the intervention period. 
```{r, eval = FALSE}
##colors c("#5DA899","#DCCD7D","#5454AA")


## Average Ozone
avg_ozone<-ozone_df %>%
  mutate(nice_Date = as.Date(strptime(Date,"%m/%d/%Y"))) %>%
  filter(nice_Date >=as.Date(strptime("","%m/%d/%Y")) & nice_Date <= as.Date(strptime("","%m/%d/%Y"))) %>%
  summarise(max_ozone = max(Ozone_AQI_Value),
            min_ozone = min(Ozone_AQI_Value),
            avg_ozone = mean(Ozone_AQI_Value))
            
## Average Outdoor PM25 
data_out$datetime_tz<-as.POSIXct(format(data_out$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
intervention_pm25<-subset(data_out, datetime_tz>=as.POSIXct(format(as.Date(strptime("","%Y-%m-%d")),tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles"))
evening_hours_inter_df<- intervention_pm25 %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_bluesky_cor,na.rm=T),
            min_pm25=min(pm2_5_bluesky_cor,na.rm = T),
            avg_pm25=mean(pm2_5_bluesky_cor,na.rm = T)) %>%
  mutate(Condition = "Outdoor") %>%
  relocate(Condition, .before=max_pm25)

avg_indr_evening_pm<- all_data %>%
  mutate(datetime_tz = as.POSIXct(format(date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles"),
         Hour = as.numeric(hour(datetime_tz))) %>%
  filter(datetime_tz>=as.POSIXct(format(as.Date(strptime("","%Y-%m-%d")),tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")) %>%
  filter(Hour <= 5 | Hour >= 19) %>%
  group_by(treatment) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
  rename(Condition = treatment)
  

## Average indoor pm25 by room  
for(i in seq(room_id_list)) {
  room = room_id_list[i]
  plot_df<-all_data[which(all_data$room_id == room),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]
  trtment<-as.character(plot_df$treatment[1])
  
    house<-plot_df$house_id[1]
  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  evening_hours_inter_rm<- plot_df %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
    rename(Condition = room_id)
  trt<-as.character(plot_df$treatment)[1]
  
  barplot_df<-rbind(evening_hours_inter_rm, avg_indr_evening_pm)
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c(room,"Treatment","Control"))
  
  if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment Group","Control"="Control Group\n(Includes Your Home)"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 22, face = "bold"),
          axis.text = element_text(size = 22, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment Group\n(Includes Your Home)","Control"="Control Group"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 22, face = "bold"),
          axis.text = element_text(size = 22,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  
  png(paste0("\\",room,"_avg_pm_barplot.png"),
             width = 1000, height = 1000)
    print(p)
    dev.off()
}
```
# Version 4: One Plot per Household

## PM 2.5 time series plot with filter data  
Houses XX do not have indoor pm2.5 data during the intervention period. 

```{r, warnings = FALSE}

missing_pm_homes<-c()
house_id_list<-unique(all_data$house_id)

## households that do not have indoor pm logged for 2nd week of intervention
plot_week1_indr<-c()

#households with no power data (no filter data)
##will highlight times when filter should be running
no_power<-c()

part_start_end$House_id<-str_sub(part_start_end$House_id,1,3)
part_start_end$start_date<-str_pad(part_start_end$start_date,6,"0",side = "left")  

intervention_pm25<-subset(all_data, date>="")
no_indoor_pm<-c()


for(i in seq(house_id_list)) {
    house<-house_id_list[i]
    
    ## Skip homes that do not have indoor pm data
    if(house %in% missing_pm_homes) {
    next
  }
  ##Subset Data to intervention period for selected room
  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  ## calculate average pm2.5 and power for household
  plot_df_avg<-plot_df %>%
    ungroup() %>%
    select(house_id,datetime_tz,pm2_5_bluesky_cor, pm2_5_indr_cor,power) %>%
    group_by(datetime_tz) %>%
    mutate(avg_indr_pm = mean(pm2_5_indr_cor, na.rm = T),
           avg_outdr_pm = mean(pm2_5_bluesky_cor, na.rm = T),
           max_power = max(power, na.rm = T)) %>%
    select(house_id, datetime_tz, avg_indr_pm, avg_outdr_pm, max_power) %>%
    distinct()
  
  ## subset power data for filter on shading
  if(house %in% no_power) {
  
  plot_df_power<-subset(plot_df, date>="" & house_id ==house)
  # start_date<-""
  # end_date<-""

  } else {
    plot_df_power<-subset(plot_df_avg, max_power>20)  

  }
  
  ## select shading based on treatment
  if(plot_df$treatment[1] == "Treatment") {
    col_trt <- "#5DA899"
  } else {
    col_trt = "#DCCD7D"
  }
  
    if(house %in% no_indoor_pm) {
    enddate<-""
  }else {
  enddate<-max(plot_df_avg$datetime_tz[which(!is.na(plot_df_avg$avg_indr_pm))])
  }
   
  start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(start_date)<-2---
  ## Adjust for timezone
  #plot_df_power$datetime_tz<-as.POSIXct(format(plot_df_power$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  plot_df_power<-subset(plot_df_power, datetime_tz>=srt_end$start_date & datetime_tz<=srt_end$end_date)
  
  ## only plot second week of intervention
  plot_df_avg$time<-1:nrow(plot_df_avg)
  secnd_wk<-round(nrow(plot_df_avg)/2,0)
  
  if(house %in% plot_week1_indr) {
    plot_df_avg<-subset(plot_df_avg, time<=secnd_wk)
    plot_df_power<-subset(plot_df_power, datetime_tz<=max(plot_df_avg$datetime_tz))
  } else {
  plot_df_avg<-subset(plot_df_avg, time>=secnd_wk)
  plot_df_power<-subset(plot_df_power, datetime_tz>=min(plot_df_avg$datetime_tz))
  }
  
  if(house %in% no_power){
    plot_df_power<-subset(plot_df_power,as.numeric(format(plot_df_power$datetime_tz, "%H"))>=20 | as.numeric(format(plot_df_power$datetime_tz, "%H"))<=5)
  }
  
  ## adjust bar heights for shading
  bar_height<-max(pmax(plot_df_avg$avg_indr_pm, plot_df_avg$avg_outdr_pm, na.rm = T), na.rm=T) +5
  mid_height<-bar_height/2
  

    col_indr <-c("steelblue1","#FFFFFF00")
    alpha_val<-0.3


# png(paste0("/",house,"_week2_full_plot.png"),
#     width=1400, height = 900)  
  
  ## full plot to save for wk 2
  p<-ggplot(plot_df_avg) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = col_trt, alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df_avg,mapping = aes(x = datetime_tz, y =avg_indr_pm, color = "Indoor"), linewidth = 1.2) +
  geom_braid(data = plot_df_avg,aes(x = datetime_tz, ymin = avg_indr_pm, ymax = avg_outdr_pm, fill = avg_indr_pm<avg_outdr_pm), alpha = alpha_val,
             method = "line") +
  geom_line(data = plot_df_avg, mapping = aes(x = datetime_tz, y = avg_outdr_pm, color = "Outdoor"),linewidth = 1.2) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("steelblue1","midnightblue")) +
  scale_fill_manual(values = col_indr, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +  
  labs(y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 25, face = "bold"),
        axis.title.y = element_text(size = 25, face = "bold"),
        legend.position = "none")
#   print(p)
#  
# dev.off() 
}
```

## Average PM 2.5 Bar Plot  
Only the evening temperatures during the intervention period.  
Capture Outdoor PM unique to each home. 

```{r, warning = FALSE}
##colors c("#5DA899","#DCCD7D","#5454AA")
avg_indr_byhome<-data.frame(matrix(ncol=6))
colnames(avg_indr_byhome)<-c("Condition","max_pm25","min_pm25","avg_pm25","avg_outdr_pm","Home")

## Average Ozone
avg_ozone<-ozone_df %>%
  mutate(nice_Date = as.Date(strptime(Date,"%m/%d/%Y"))) %>%
  filter(nice_Date >=as.Date(strptime("10/07/2023","%m/%d/%Y")) & nice_Date <= as.Date(strptime("10/29/2023","%m/%d/%Y"))) %>%
  summarise(max_ozone = max(Ozone_AQI_Value),
            min_ozone = min(Ozone_AQI_Value),
            avg_ozone = mean(Ozone_AQI_Value))
            
## Average Outdoor PM25 
data_out$datetime_tz<-as.POSIXct(format(data_out$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
intervention_pm25<-subset(data_out, datetime_tz>=as.POSIXct(format(as.Date(strptime("2023-10-07","%Y-%m-%d")),tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles"))
evening_hours_inter_df<- intervention_pm25 %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_bluesky_cor,na.rm=T),
            min_pm25=min(pm2_5_bluesky_cor,na.rm = T),
            avg_pm25=mean(pm2_5_bluesky_cor,na.rm = T)) %>%
  mutate(Condition = "Outdoor") %>%
  relocate(Condition, .before=max_pm25)

avg_indr_evening_pm<- all_data %>%
  mutate(datetime_tz = as.POSIXct(format(date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles"),
         Hour = as.numeric(hour(datetime_tz))) %>%
  filter(datetime_tz>=as.POSIXct(format(as.Date(strptime("","%Y-%m-%d")),tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")) %>%
  filter(Hour <= 5 | Hour >= 19) %>%
  group_by(treatment) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
  rename(Condition = treatment)
  

## Average indoor pm25 by room  
for(i in seq(house_id_list)) {
  house = house_id_list[i]
  if(house %in% missing_pm_homes) {
    next
  }
  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]
  trtment<-as.character(plot_df$treatment[1])

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  evening_hours_inter_rm<- plot_df %>%
    ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
    mutate(Condition = "Your Home") %>%
    relocate(Condition, .before = max_pm25)
  
 

  
  barplot_df<-rbind(evening_hours_inter_rm, avg_indr_evening_pm)
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c("Your Home","Treatment","Control"))
  
  if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment\nGroup","Control"="Control\nGroup\n(Includes Your Home)"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 28, face = "bold"),
          axis.text = element_text(size = 28, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment\nGroup\n(Includes Your Home)","Control"="Control\nGroup"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 28, face = "bold"),
          axis.text = element_text(size = 28,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  
  # png(paste0("\\",house,"_avg_pm_barplot.png"),
  #            width = 1000, height = 1000)
  #   print(p)
  #   dev.off()
    
    evening_hours_inter_rm <-plot_df %>%
          ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T),
            avg_outdr_pm=mean(pm2_5_bluesky_cor, na.rm = T)) %>%
    mutate(Condition = "Your Home",
           Home = house) %>%
    relocate(Condition, .before = max_pm25)
  
     avg_indr_byhome<-rbind(avg_indr_byhome,evening_hours_inter_rm)
}

```

## Average PM2.5 barplot for homes without indoor pm  

```{r, eval =FALSE}

for(i in seq(missing_pm_homes)) {
  house = missing_pm_homes[i]
  
    plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]
  trtment<-as.character(plot_df$treatment[1])

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 

  
  barplot_df<-avg_indr_evening_pm
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c("Treatment","Control"))
  
    if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    annotate("text", x = "Control", y = 4, label = "Your home\nis in this group.", size = 8, fontface = "bold") +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c("Treatment"="Treatment Group","Control"="Control Group"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 23, face = "bold"),
          axis.text = element_text(size = 25, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    annotate("text", x = "Treatment", y = 4, label = "Your home\nis in this group.", size = 8, fontface = "bold") +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c("Treatment"="Treatment Group","Control"="Control Group"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 23, face = "bold"),
          axis.text = element_text(size = 25,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  
  png(paste0("\\",house,"_avg_pm_barplot.png"),
             width = 1000, height = 1000)
    print(p)
    dev.off()
    
}
```

## Average PM2.5 barplot for homes without indoor pm - Version 2 with "No Data"

```{r}

for(i in seq(missing_pm_homes)) {
  house = missing_pm_homes[i]
  

  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]
  trtment<-as.character(plot_df$treatment[1])

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2023
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2023
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  evening_hours_inter_rm<- plot_df %>%
    ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
    mutate(Condition = "Your Home") %>%
    relocate(Condition, .before = max_pm25)

  
  barplot_df<-rbind(evening_hours_inter_rm, avg_indr_evening_pm)
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c("Your Home","Treatment","Control"))
  
  if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    annotate("text", x = "Control", y = 3, label = "Your home\nis in this group.", size = 8, fontface = "bold") +
    annotate("text", x = "Your Home", y = 3, label = "No Data", size = 10, fontface = "bold") +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment Group","Control"="Control Group"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    annotate("text", x = "Treatment", y = 3, label = "Your home\nis in this group.", size = 8, fontface = "bold") +
    annotate("text", x = "Your Home", y = 3, label = "No Data", size = 10, fontface = "bold") +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment Group","Control"="Control Group"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  

  
  png(paste0("\\",house,"_avg_pm_barplot_v2.png"),
             width = 1000, height = 1000)
    print(p)
    dev.off()
    
}
```

## PM 2.5 time series plot without filter data for homes missing indoor PM  

```{r}
for(i in seq(missing_pm_homes)) {
  house = missing_pm_homes[i]
    

  ##Subset Data to intervention period for selected room
  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  ## calculate average pm2.5 and power for household
  plot_df_avg<-plot_df %>%
    ungroup() %>%
    select(house_id,datetime_tz,pm2_5_bluesky_cor, pm2_5_indr_cor,power) %>%
    group_by(datetime_tz) %>%
    mutate(avg_indr_pm = mean(pm2_5_indr_cor, na.rm = T),
           avg_outdr_pm = mean(pm2_5_bluesky_cor, na.rm = T),
           max_power = max(power, na.rm = T)) %>%
    select(house_id, datetime_tz, avg_indr_pm, avg_outdr_pm, max_power) %>%
    distinct()
  
  
  ## select shading based on treatment
  if(plot_df$treatment[1] == "Treatment") {
    col_trt <- "#5DA899"
  } else {
    col_trt = "#DCCD7D"
  }
  

  enddate<-max(plot_df_avg$datetime_tz[which(!is.na(plot_df_avg$avg_indr_pm))])
   
  start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(start_date)<-2---

  ## only plot second week of intervention
  plot_df_avg$time<-1:nrow(plot_df_avg)
  secnd_wk<-round(nrow(plot_df_avg)/2,0)
  
  if(house %in% plot_week1_indr) {
    plot_df_avg<-subset(plot_df_avg, time<=secnd_wk)
  } else {
  plot_df_avg<-subset(plot_df_avg, time>=secnd_wk)

  }
  

    col_indr <-c("steelblue1","#FFFFFF00")
    alpha_val<-0.3


png(paste0("/",house,"_week2_nofilter_plot.png"),
    width=1400, height = 900)  
  
  ## full plot to save for wk 2
  p<-ggplot(plot_df_avg) +
  geom_line(data=plot_df_avg,mapping = aes(x = datetime_tz, y =avg_indr_pm, color = "Indoor"), linewidth = 1.2) +
  geom_braid(data = plot_df_avg,aes(x = datetime_tz, ymin = avg_indr_pm, ymax = avg_outdr_pm, fill = avg_indr_pm<avg_outdr_pm), alpha = alpha_val,
             method = "line") +
  geom_line(data = plot_df_avg, mapping = aes(x = datetime_tz, y = avg_outdr_pm, color = "Outdoor"),linewidth = 1.2) +
  scale_y_continuous(expand = c(0,0), limits = c(0,32))+
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("steelblue1","midnightblue")) +
  scale_fill_manual(values = col_indr, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +  
  labs(y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 25, face = "bold"),
        axis.title.y = element_text(size = 25, face = "bold"),
        panel.grid.major.y = element_line(color = "gray75"),
        legend.position = "none")
  print(p)
 
dev.off() 
}
```
## Average PM 2.5 Bar Plot, Spanish Version 
Only the evening temperatures during the intervention period.  
Capture Outdoor PM unique to each home. 

```{r, warning = FALSE}
##colors c("#5DA899","#DCCD7D","#5454AA")


## Average Ozone
avg_ozone<-ozone_df %>%
  mutate(nice_Date = as.Date(strptime(Date,"%m/%d/%Y"))) %>%
  filter(nice_Date >=as.Date(strptime("","%m/%d/%Y")) & nice_Date <= as.Date(strptime("","%m/%d/%Y"))) %>%
  summarise(max_ozone = max(Ozone_AQI_Value),
            min_ozone = min(Ozone_AQI_Value),
            avg_ozone = mean(Ozone_AQI_Value))
            
## Average Outdoor PM25 
data_out$datetime_tz<-as.POSIXct(format(data_out$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
intervention_pm25<-subset(data_out, datetime_tz>=as.POSIXct(format(as.Date(strptime("","%Y-%m-%d")),tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles"))
evening_hours_inter_df<- intervention_pm25 %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_bluesky_cor,na.rm=T),
            min_pm25=min(pm2_5_bluesky_cor,na.rm = T),
            avg_pm25=mean(pm2_5_bluesky_cor,na.rm = T)) %>%
  mutate(Condition = "Outdoor") %>%
  relocate(Condition, .before=max_pm25)

avg_indr_evening_pm<- all_data %>%
  mutate(datetime_tz = as.POSIXct(format(date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles"),
         Hour = as.numeric(hour(datetime_tz))) %>%
  filter(datetime_tz>=as.POSIXct(format(as.Date(strptime("","%Y-%m-%d")),tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")) %>%
  filter(Hour <= 5 | Hour >= 19) %>%
  group_by(treatment) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
  rename(Condition = treatment)
  

## Average indoor pm25 by room  
for(i in seq(house_id_list)) {
  house = house_id_list[i]
  if(house %in% missing_pm_homes) {
    next
  }
  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]
  trtment<-as.character(plot_df$treatment[1])

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  evening_hours_inter_rm<- plot_df %>%
    ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
    mutate(Condition = "Your Home") %>%
    relocate(Condition, .before = max_pm25)

  
  barplot_df<-rbind(evening_hours_inter_rm, avg_indr_evening_pm)
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c("Your Home","Treatment","Control"))
  
  if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment Group","Control"="Control Group\n(Includes Your Home)"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment Group\n(Includes Your Home)","Control"="Control Group"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  
  png(paste0("\\",house,"_avg_pm_barplot_span.png"),
             width = 1000, height = 1000)
    print(p)
    dev.off()
}

```


## Average PM2.5 barplot for homes without indoor pm - Version 2 with "No Data", Spanish Version

```{r}

for(i in seq(missing_pm_homes)) {
  house = missing_pm_homes[i]
  

  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]
  trtment<-as.character(plot_df$treatment[1])

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  evening_hours_inter_rm<- plot_df %>%
    ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
    mutate(Condition = "Your Home") %>%
    relocate(Condition, .before = max_pm25)

  
  barplot_df<-rbind(evening_hours_inter_rm, avg_indr_evening_pm)
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c("Your Home","Treatment","Control"))
  Sys.setlocale("LC_TIME","Spanish") 
  if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    annotate("text", x = "Control", y = 3, label = "Su casa\n est\u0061 en\n este grupo.", size = 8, fontface = "bold") +
    annotate("text", x = "Your Home", y = 3, label = "Sin datos", size = 10, fontface = "bold") +
    scale_x_discrete(labels = c(room="Su Casa","Treatment"="Grupo de\ntratamiento","Control"="Grupo de\ncontrol"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    annotate("text", x = "Treatment", y = 3, label = "Su casa\n est\u0061 en\n este grupo.", size = 8, fontface = "bold") +
    annotate("text", x = "Your Home", y = 3, label = "Sin datos", size = 10, fontface = "bold") +
    scale_x_discrete(labels = c(room="Su Casa","Treatment"="Grupo de\ntratamiento","Control"="Grupo de\ncontrol"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  

  
  png(paste0("\\",house,"_avg_pm_barplot_v2_span.png"),
             width = 1000, height = 1000)
    print(p)
    dev.off()
  Sys.setlocale("LC_TIME","English")  
}
```

## PM 2.5 time series plot without filter data for homes missing indoor PM, Spanish Version

```{r}
for(i in seq(missing_pm_homes)) {
  house = missing_pm_homes[i]
    

  ##Subset Data to intervention period for selected room
  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  ## calculate average pm2.5 and power for household
  plot_df_avg<-plot_df %>%
    ungroup() %>%
    select(house_id,datetime_tz,pm2_5_bluesky_cor, pm2_5_indr_cor,power) %>%
    group_by(datetime_tz) %>%
    mutate(avg_indr_pm = mean(pm2_5_indr_cor, na.rm = T),
           avg_outdr_pm = mean(pm2_5_bluesky_cor, na.rm = T),
           max_power = max(power, na.rm = T)) %>%
    select(house_id, datetime_tz, avg_indr_pm, avg_outdr_pm, max_power) %>%
    distinct()
  
  
  ## select shading based on treatment
  if(plot_df$treatment[1] == "Treatment") {
    col_trt <- "#5DA899"
  } else {
    col_trt = "#DCCD7D"
  }
  

  enddate<-max(plot_df_avg$datetime_tz[which(!is.na(plot_df_avg$avg_indr_pm))])
   
  start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(start_date)<-2---

  ## only plot second week of intervention
  plot_df_avg$time<-1:nrow(plot_df_avg)
  secnd_wk<-round(nrow(plot_df_avg)/2,0)
  
  if(house %in% plot_week1_indr) {
    plot_df_avg<-subset(plot_df_avg, time<=secnd_wk)
  } else {
  plot_df_avg<-subset(plot_df_avg, time>=secnd_wk)

  }
  

    col_indr <-c("steelblue1","#FFFFFF00")
    alpha_val<-0.3
 Sys.setlocale("LC_TIME","Spanish")

png(paste0("/",house,"_week2_nofilter_plot_span.png"),
    width=1400, height = 900)  
  
  ## full plot to save for wk 2
  p<-ggplot(plot_df_avg) +
  geom_line(data=plot_df_avg,mapping = aes(x = datetime_tz, y =avg_indr_pm, color = "Indoor"), linewidth = 1.2) +
  geom_braid(data = plot_df_avg,aes(x = datetime_tz, ymin = avg_indr_pm, ymax = avg_outdr_pm, fill = avg_indr_pm<avg_outdr_pm), alpha = alpha_val,
             method = "line") +
  geom_line(data = plot_df_avg, mapping = aes(x = datetime_tz, y = avg_outdr_pm, color = "Outdoor"),linewidth = 1.2) +
  scale_y_continuous(expand = c(0,0), limits=c(0,32))+
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("steelblue1","midnightblue")) +
  scale_fill_manual(values = col_indr, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +  
  labs(y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 25, face = "bold"),
        axis.title.y = element_text(size = 25, face = "bold"),
        panel.grid.major.y = element_line(color = "gray75"),
        legend.position = "none")
  print(p)
 
dev.off() 
Sys.setlocale("LC_TIME","English")
}
```


## Average PM 2.5 Bar Plot, Spanish Version 
Only the evening temperatures during the intervention period.  
Capture Outdoor PM unique to each home. 

```{r, warning = FALSE}
##colors c("#5DA899","#DCCD7D","#5454AA")


## Average Ozone
avg_ozone<-ozone_df %>%
  mutate(nice_Date = as.Date(strptime(Date,"%m/%d/%Y"))) %>%
  filter(nice_Date >=as.Date(strptime("","%m/%d/%Y")) & nice_Date <= as.Date(strptime("","%m/%d/%Y"))) %>%
  summarise(max_ozone = max(Ozone_AQI_Value),
            min_ozone = min(Ozone_AQI_Value),
            avg_ozone = mean(Ozone_AQI_Value))
            
## Average Outdoor PM25 
data_out$datetime_tz<-as.POSIXct(format(data_out$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
intervention_pm25<-subset(data_out, datetime_tz>=as.POSIXct(format(as.Date(strptime("","%Y-%m-%d")),tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles"))
evening_hours_inter_df<- intervention_pm25 %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_bluesky_cor,na.rm=T),
            min_pm25=min(pm2_5_bluesky_cor,na.rm = T),
            avg_pm25=mean(pm2_5_bluesky_cor,na.rm = T)) %>%
  mutate(Condition = "Outdoor") %>%
  relocate(Condition, .before=max_pm25)

avg_indr_evening_pm<- all_data %>%
  mutate(datetime_tz = as.POSIXct(format(date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles"),
         Hour = as.numeric(hour(datetime_tz))) %>%
  filter(datetime_tz>=as.POSIXct(format(as.Date(strptime("","%Y-%m-%d")),tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")) %>%
  filter(Hour <= 5 | Hour >= 19) %>%
  group_by(treatment) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
  rename(Condition = treatment)
  

## Average indoor pm25 by room  
for(i in seq(house_id_list)) {
  house = house_id_list[i]
  if(house %in% missing_pm_homes) {
    next
  }
  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]
  trtment<-as.character(plot_df$treatment[1])

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  evening_hours_inter_rm<- plot_df %>%
    ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
    mutate(Condition = "Your Home") %>%
    relocate(Condition, .before = max_pm25)

  
  barplot_df<-rbind(evening_hours_inter_rm, avg_indr_evening_pm)
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c("Your Home","Treatment","Control"))
  Sys.setlocale("LC_TIME","Spanish")
  if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Su Casa","Treatment"="Grupo de\ntratamiento","Control"="Grupo de\ncontrol"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Su Casa","Treatment"="Grupo de\ntratamiento","Control"="Grupo de\ncontrol"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  
  png(paste0("\\",house,"_avg_pm_barplot_span.png"),
             width = 1000, height = 1000)
    print(p)
    dev.off()
  Sys.setlocale("LC_TIME","English")
}

```

## PM 2.5 time series plot with filter data, Spanish Version  
Houses H01, H19, H28, H31, H34 do not have indoor pm2.5 data during the intervention period. 

```{r, warnings = FALSE}

missing_pm_homes<-c()
house_id_list<-unique(all_data$house_id)

## households that do not have indoor pm logged for 2nd week of intervention
plot_week1_indr<-c()

#households with no power data (no filter data)
##will highlight times when filter should be running
no_power<-c()

part_start_end$House_id<-str_sub(part_start_end$House_id,1,3)
part_start_end$start_date<-str_pad(part_start_end$start_date,6,"0",side = "left")  

intervention_pm25<-subset(all_data, date>="")
no_indoor_pm<-c()



for(i in seq(house_id_list)) {
    house<-house_id_list[i]
    
    ## Skip homes that do not have indoor pm data
    if(house %in% missing_pm_homes) {
    next
  }
  ##Subset Data to intervention period for selected room
  plot_df<-all_data[which(all_data$house_id == house),c("room_id","house_id","date","pm2_5_bluesky_cor","main_door","pm2_5_indr_cor","other_door","power","treatment")]

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  ## calculate average pm2.5 and power for household
  plot_df_avg<-plot_df %>%
    ungroup() %>%
    select(house_id,datetime_tz,pm2_5_bluesky_cor, pm2_5_indr_cor,power) %>%
    group_by(datetime_tz) %>%
    mutate(avg_indr_pm = mean(pm2_5_indr_cor, na.rm = T),
           avg_outdr_pm = mean(pm2_5_bluesky_cor, na.rm = T),
           max_power = max(power, na.rm = T)) %>%
    select(house_id, datetime_tz, avg_indr_pm, avg_outdr_pm, max_power) %>%
    distinct()
  
  ## subset power data for filter on shading
  if(house %in% no_power) {
  
  plot_df_power<-subset(plot_df, date>="" & house_id ==house)
  # start_date<-""
  # end_date<-""

  } else {
    plot_df_power<-subset(plot_df_avg, max_power>20)  

  }
  
  ## select shading based on treatment
  if(plot_df$treatment[1] == "Treatment") {
    col_trt <- "#5DA899"
  } else {
    col_trt = "#DCCD7D"
  }
  
    if(house %in% no_indoor_pm) {
    enddate<-""
  }else {
  enddate<-max(plot_df_avg$datetime_tz[which(!is.na(plot_df_avg$avg_indr_pm))])
  }
   
  start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(start_date)<-2---
  ## Adjust for timezone
  #plot_df_power$datetime_tz<-as.POSIXct(format(plot_df_power$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  plot_df_power<-subset(plot_df_power, datetime_tz>=srt_end$start_date & datetime_tz<=srt_end$end_date)
  
  ## only plot second week of intervention
  plot_df_avg$time<-1:nrow(plot_df_avg)
  secnd_wk<-round(nrow(plot_df_avg)/2,0)
  
  if(house %in% plot_week1_indr) {
    plot_df_avg<-subset(plot_df_avg, time<=secnd_wk)
    plot_df_power<-subset(plot_df_power, datetime_tz<=max(plot_df_avg$datetime_tz))
  } else {
  plot_df_avg<-subset(plot_df_avg, time>=secnd_wk)
  plot_df_power<-subset(plot_df_power, datetime_tz>=min(plot_df_avg$datetime_tz))
  }
  
  if(house %in% no_power){
    plot_df_power<-subset(plot_df_power,as.numeric(format(plot_df_power$datetime_tz, "%H"))>=20 | as.numeric(format(plot_df_power$datetime_tz, "%H"))<=5)
  }
  
  ## adjust bar heights for shading
  bar_height<-max(pmax(plot_df_avg$avg_indr_pm, plot_df_avg$avg_outdr_pm, na.rm = T), na.rm=T) +5
  mid_height<-bar_height/2
  

    col_indr <-c("steelblue1","#FFFFFF00")
    alpha_val<-0.3
Sys.setlocale("LC_TIME","Spanish")

png(paste0("/",house,"_week2_full_plot_span.png"),
    width=1400, height = 900)  
  
  ## full plot to save for wk 2
  p<-ggplot(plot_df_avg) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = col_trt, alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df_avg,mapping = aes(x = datetime_tz, y =avg_indr_pm, color = "Indoor"), linewidth = 1.2) +
  geom_braid(data = plot_df_avg,aes(x = datetime_tz, ymin = avg_indr_pm, ymax = avg_outdr_pm, fill = avg_indr_pm<avg_outdr_pm), alpha = alpha_val,
             method = "line") +
  geom_line(data = plot_df_avg, mapping = aes(x = datetime_tz, y = avg_outdr_pm, color = "Outdoor"),linewidth = 1.2) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("steelblue1","midnightblue")) +
  scale_fill_manual(values = col_indr, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +  
  labs(y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 25, face = "bold"),
        axis.title.y = element_text(size = 25, face = "bold"),
        legend.position = "none")
  print(p)
 
dev.off() 
Sys.setlocale("LC_TIME","English")
}


```

# Ambassador Houses  

## Bar Plot English Version

```{r}

  house = ""

  plot_df<-all_data_ambassador[which(all_data_ambassador$house_id == house),c("room_id","house_id","date","pm2_5_indr_cor","pm2_5_bluesky","power")]
  trtment<-"treatment"

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  evening_hours_inter_rm<- plot_df %>%
    ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
    mutate(Condition = "Your Home") %>%
    relocate(Condition, .before = max_pm25)
  
 
  barplot_df<-rbind(evening_hours_inter_rm, avg_indr_evening_pm)
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c("Your Home","Treatment","Control"))
  
  if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment\nGroup","Control"="Control\nGroup\n(Includes Your Home)"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 28, face = "bold"),
          axis.text = element_text(size = 28, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Your Home","Treatment"="Treatment\nGroup\n(Includes Your Home)","Control"="Control\nGroup"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 28, face = "bold"),
          axis.text = element_text(size = 28,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  
  png(paste0("\\",house,"_avg_pm_barplot.png"),
             width = 1000, height = 1000)
    print(p)
    dev.off()
    
    evening_hours_inter_rm <-plot_df %>%
          ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
      mutate(pm2_5_bluesky_cor = 4.31 + 0.8746*pm2_5_bluesky) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T),
            avg_outdr_pm=mean(pm2_5_bluesky_cor, na.rm = T)) %>%
    mutate(Condition = "Your Home",
           Home = house) %>%
    relocate(Condition, .before = max_pm25)
  

```


## Time line Plot Eng Version

```{r}

    house<-""
    

  ##Subset Data to intervention period for selected room
  plot_df<-all_data_ambassador[which(all_data_ambassador$house_id == house),c("room_id","house_id","date","pm2_5_indr_cor","pm2_5_bluesky","power")]
  trtment<-"treatment"
  plot_df<- plot_df %>%
    mutate(pm2_5_bluesky_cor = 4.31 + 0.8746*pm2_5_bluesky)

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")

  srt_end$start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  ## calculate average pm2.5 and power for household
  plot_df_avg<-plot_df %>%
    ungroup() %>%
    select(house_id,datetime_tz,pm2_5_bluesky_cor, pm2_5_indr_cor,power) %>%
    group_by(datetime_tz) %>%
    mutate(avg_indr_pm = mean(pm2_5_indr_cor, na.rm = T),
           avg_outdr_pm = mean(pm2_5_bluesky_cor, na.rm = T),
           max_power = max(power, na.rm = T)) %>%
    select(house_id, datetime_tz, avg_indr_pm, avg_outdr_pm, max_power) %>%
    distinct()
  
  ## subset power data for filter on shading
  # if(house %in% no_power) {
  # 
  # plot_df_power<-subset(plot_df, date>="" & house_id ==house)
  # # start_date<-""
  # # end_date<-""
  # 
  # } else {
    plot_df_power<-subset(plot_df_avg, max_power>20)  

  #}
  

    col_trt <- "#5DA899"

  

  enddate<-max(plot_df_avg$datetime_tz[which(!is.na(plot_df_avg$avg_indr_pm))])

   
  start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(start_date)<-2---
  ## Adjust for timezone
  #plot_df_power$datetime_tz<-as.POSIXct(format(plot_df_power$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  plot_df_power<-subset(plot_df_power, datetime_tz>=srt_end$start_date & datetime_tz<=srt_end$end_date)
  
  ## only plot second week of intervention
  plot_df_avg$time<-1:nrow(plot_df_avg)
  secnd_wk<-round(nrow(plot_df_avg)/2,0)
  
  if(house %in% plot_week1_indr) {
    plot_df_avg<-subset(plot_df_avg, time<=secnd_wk)
    plot_df_power<-subset(plot_df_power, datetime_tz<=max(plot_df_avg$datetime_tz))
  } else {
  plot_df_avg<-subset(plot_df_avg, time>=secnd_wk)
  plot_df_power<-subset(plot_df_power, datetime_tz>=min(plot_df_avg$datetime_tz))
  }
  
  if(house %in% no_power){
    plot_df_power<-subset(plot_df_power,as.numeric(format(plot_df_power$datetime_tz, "%H"))>=20 | as.numeric(format(plot_df_power$datetime_tz, "%H"))<=5)
  }
  
  ## adjust bar heights for shading
  bar_height<-max(pmax(plot_df_avg$avg_indr_pm, plot_df_avg$avg_outdr_pm, na.rm = T), na.rm=T) +5
  mid_height<-bar_height/2
  

    col_indr <-c("steelblue1","#FFFFFF00")
    alpha_val<-0.3


png(paste0("/",house,"_week2_full_plot.png"),
    width=1400, height = 900)
  
  ## full plot to save for wk 2
  p<-ggplot(plot_df_avg) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = col_trt, alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df_avg,mapping = aes(x = datetime_tz, y =avg_indr_pm, color = "Indoor"), linewidth = 1.2) +
  geom_braid(data = plot_df_avg,aes(x = datetime_tz, ymin = avg_indr_pm, ymax = avg_outdr_pm, fill = avg_indr_pm<avg_outdr_pm), alpha = alpha_val,
             method = "line") +
  geom_line(data = plot_df_avg, mapping = aes(x = datetime_tz, y = avg_outdr_pm, color = "Outdoor"),linewidth = 1.2) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("steelblue1","midnightblue")) +
  scale_fill_manual(values = col_indr, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +  
  labs(y=expression("Particle Concentration - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 25, face = "bold"),
        axis.title.y = element_text(size = 25, face = "bold"),
        legend.position = "none")
  print(p)

dev.off()

```
## Bar Plot Spanish Version 

```{r}

  house = ""

 plot_df<-all_data_ambassador[which(all_data_ambassador$house_id == house),c("room_id","house_id","date","pm2_5_indr_cor","pm2_5_bluesky","power")]
  trtment<-"treatment"

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  #plot_df$date_daymon<-as.Date(plot_df$datetime_tz,format = "%d-%b")
  srt_end$start_date<-as.Date(srt_end$start_date,format = "%d-%b")
  year(srt_end$start_date)<-2023
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2023
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  evening_hours_inter_rm<- plot_df %>%
    ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T)) %>%
    mutate(Condition = "Your Home") %>%
    relocate(Condition, .before = max_pm25)
  
 
  barplot_df<-rbind(evening_hours_inter_rm, avg_indr_evening_pm)
  barplot_df$Condition<-factor(barplot_df$Condition, levels = c("Your Home","Treatment","Control"))

  Sys.setlocale("LC_TIME","Spanish")
  if(trtment == "Control"){
  
  p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Su Casa","Treatment"="Grupo de\ntratamiento","Control"="Grupo de\ncontrol"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25, face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  } else {
      p <-ggplot(barplot_df, aes(x = Condition, y = avg_pm25, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    labs(x = "",y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
    scale_fill_manual(values = c("#5454AA","#5DA899","#DCCD7D")) +
    scale_x_discrete(labels = c(room="Su Casa","Treatment"="Grupo de\ntratamiento","Control"="Grupo de\ncontrol"))+
    scale_y_continuous(expand = c(0,0)) +
    theme(legend.position = "none", 
          axis.title.y = element_text(size = 25, face = "bold"),
          axis.text = element_text(size = 25,face = "bold"),
          axis.ticks = element_blank(),
          panel.background = element_blank(),
        #axis.line = element_line(color = "black"),
        panel.grid.major.y = element_line(color = "gray70",linewidth = 1.5))
  }
  
  png(paste0("\\",house,"_avg_pm_barplot_span.png"),
             width = 1000, height = 1000)
    print(p)
    dev.off()
  Sys.setlocale("LC_TIME","English")


    evening_hours_inter_rm <-plot_df %>%
          ungroup() %>%
   mutate(Hour = as.numeric(hour(datetime_tz))) %>% 
  filter(Hour <= 5 | Hour >= 19) %>%
      mutate(pm2_5_bluesky_cor = 4.31 + 0.8746*pm2_5_bluesky) %>%
  summarise(max_pm25=max(pm2_5_indr_cor,na.rm=T),
            min_pm25=min(pm2_5_indr_cor,na.rm = T),
            avg_pm25=mean(pm2_5_indr_cor,na.rm = T),
            avg_outdr_pm=mean(pm2_5_bluesky_cor, na.rm = T)) %>%
    mutate(Condition = "Your Home",
           Home = house) %>%
    relocate(Condition, .before = max_pm25)
```



## Time Line Plot Spanish Version  

```{r}


  house = ""

  ##Subset Data to intervention period for selected room
  plot_df<-all_data_ambassador[which(all_data_ambassador$house_id == house),c("room_id","house_id","date","pm2_5_indr_cor","pm2_5_bluesky","power")]
  trtment<-"treatment"
  plot_df<- plot_df %>%
    mutate(pm2_5_bluesky_cor = 4.31 + 0.8746*pm2_5_bluesky)

  srt_end<-distinct(part_start_end[which(part_start_end$House_id == house),2:4])
  plot_df$datetime_tz<-as.POSIXct(format(plot_df$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")

  srt_end$start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(srt_end$start_date)<-2---
  srt_end$end_date<-as.Date(srt_end$end_date, format = "%d-%b")
  year(srt_end$end_date)<-2---
  plot_df<-subset(plot_df, datetime_tz >= srt_end$start_date & datetime_tz <=srt_end$end_date) 
  
  ## calculate average pm2.5 and power for household
  plot_df_avg<-plot_df %>%
    ungroup() %>%
    select(house_id,datetime_tz,pm2_5_bluesky_cor, pm2_5_indr_cor,power) %>%
    group_by(datetime_tz) %>%
    mutate(avg_indr_pm = mean(pm2_5_indr_cor, na.rm = T),
           avg_outdr_pm = mean(pm2_5_bluesky_cor, na.rm = T),
           max_power = max(power, na.rm = T)) %>%
    select(house_id, datetime_tz, avg_indr_pm, avg_outdr_pm, max_power) %>%
    distinct()
  
  ## subset power data for filter on shading
  # if(house %in% no_power) {
  # 
  # plot_df_power<-subset(plot_df, date>="" & house_id ==house)
  # # start_date<-""
  # # end_date<-""
  # 
  # } else {
    plot_df_power<-subset(plot_df_avg, max_power>20)  

  #}
  

    col_trt <- "#5DA899"

  

  enddate<-max(plot_df_avg$datetime_tz[which(!is.na(plot_df_avg$avg_indr_pm))])

   
  start_date<-as.Date(srt_end$start_date, format = "%d-%b")
  year(start_date)<-2023
  ## Adjust for timezone
  #plot_df_power$datetime_tz<-as.POSIXct(format(plot_df_power$date, tz="America/Los_Angeles",usetz = TRUE),tz = "America/Los_Angeles")
  plot_df_power<-subset(plot_df_power, datetime_tz>=srt_end$start_date & datetime_tz<=srt_end$end_date)
  
  ## only plot second week of intervention
  plot_df_avg$time<-1:nrow(plot_df_avg)
  secnd_wk<-round(nrow(plot_df_avg)/2,0)
  
  if(house %in% plot_week1_indr) {
    plot_df_avg<-subset(plot_df_avg, time<=secnd_wk)
    plot_df_power<-subset(plot_df_power, datetime_tz<=max(plot_df_avg$datetime_tz))
  } else {
  plot_df_avg<-subset(plot_df_avg, time>=secnd_wk)
  plot_df_power<-subset(plot_df_power, datetime_tz>=min(plot_df_avg$datetime_tz))
  }
  
  if(house %in% no_power){
    plot_df_power<-subset(plot_df_power,as.numeric(format(plot_df_power$datetime_tz, "%H"))>=20 | as.numeric(format(plot_df_power$datetime_tz, "%H"))<=5)
  }
  
  ## adjust bar heights for shading
  bar_height<-max(pmax(plot_df_avg$avg_indr_pm, plot_df_avg$avg_outdr_pm, na.rm = T), na.rm=T) +5
  mid_height<-bar_height/2
  

    col_indr <-c("steelblue1","#FFFFFF00")
    alpha_val<-0.3
Sys.setlocale("LC_TIME","Spanish")

png(paste0("/",house,"_week2_full_plot_span.png"),
    width=1400, height = 900)  
  
  ## full plot to save for wk 2
  p<-ggplot(plot_df_avg) +
  geom_tile(data = plot_df_power, mapping = aes(x=datetime_tz,y = mid_height), 
            fill = col_trt, alpha = 0.2, height = bar_height) +
  geom_line(data=plot_df_avg,mapping = aes(x = datetime_tz, y =avg_indr_pm, color = "Indoor"), linewidth = 1.2) +
  geom_braid(data = plot_df_avg,aes(x = datetime_tz, ymin = avg_indr_pm, ymax = avg_outdr_pm, fill = avg_indr_pm<avg_outdr_pm), alpha = alpha_val,
             method = "line") +
  geom_line(data = plot_df_avg, mapping = aes(x = datetime_tz, y = avg_outdr_pm, color = "Outdoor"),linewidth = 1.2) +
  scale_y_continuous(expand = c(0,0))+
  scale_x_datetime(date_breaks = "1 days", date_labels = "%b %d") +
  scale_color_manual(name = "Air Quality", labels = c("Indoor","Outdoor"), values = c("steelblue1","midnightblue")) +
  scale_fill_manual(values = col_indr, name = "", labels = c("PM 2.5 Concentration Larger Indoor","")) +  
  labs(y=expression("Concentraci\u006Fn de part\u0069culas - PM" [2.5] *" (" *mu *"g/m" ^3 *")")) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.text = element_text(size = 25, face = "bold"),
        axis.title.y = element_text(size = 25, face = "bold"),
        legend.position = "none")
  print(p)
 
dev.off() 
Sys.setlocale("LC_TIME","English")

```

